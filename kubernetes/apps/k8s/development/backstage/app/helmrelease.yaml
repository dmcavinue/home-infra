---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: backstage
  namespace: development
spec:
  interval: 30m
  chart:
    spec:
      chart: backstage
      version: 1.3.0
      sourceRef:
        kind: HelmRepository
        name: backstage
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    ingress:
      enabled: true
      className: nginx
      host: backstage.nucstack.com
      tls:
        enabled: true
        secretName: nucstack-com-tls

    backstage:
      replicas: 1
      revisionHistoryLimit: 10

      resources:
        limits:
          memory: 1Gi
          cpu: 1000m
        requests:
          memory: 250Mi
          cpu: 100m 
    postgresql:
      enabled: false
      auth:
        # -- Name for a custom user to create
        username: bn_backstage

        # -- Password for the custom user to create
        password: ""

        # -- Name of existing secret to use for PostgreSQL credentials
        existingSecret: "backstage-secret"

        # -- The secret keys Postgres will look for to retrieve the relevant password
        secretKeys:

          # -- The key in which Postgres will look for, for the admin password, in the existing Secret
          adminPasswordKey: admin-password

          # -- The key in which Postgres will look for, for the user password, in the existing Secret
          userPasswordKey: user-password

          # -- The key in which Postgres will look for, for the replication password, in the existing Secret
          replicationPasswordKey: replication-password
      architecture: standalone
    serviceAccount:
      create: true
      name: backstage

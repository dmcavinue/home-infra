---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: backstage
  namespace: development
spec:
  interval: 30m
  chart:
    spec:
      chart: backstage
      version: 1.3.0
      sourceRef:
        kind: HelmRepository
        name: backstage
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    ingress:
      enabled: true
      className: nginx
      host: backstage.nucstack.com
      tls:
        enabled: true
        secretName: nucstack-com-tls
    backstage:
      replicas: 1
      revisionHistoryLimit: 10
      resources:
        limits:
          memory: 1Gi
          cpu: 1000m
        requests:
          memory: 250Mi
          cpu: 100m
      extraEnvVars:
        - name: POSTGRES_HOST
          value: "backstage-rw"
        - name: POSTGRES_PORT
          value: "5432"
    postgresql:
      enabled: false
      architecture: standalone
    serviceAccount:
      create: true
      name: backstage-sa
  valuesFrom:
    - targetPath: postgresql.auth.username
      kind: Secret
      name: backstage-database-user
      valuesKey: username
    - targetPath: postgresql.auth.password
      kind: Secret
      name: backstage-database-user
      valuesKey: password
    - targetPath: postgresql.auth.secretKeys.userPasswordKey
      kind: Secret
      name: backstage-database-user
      valuesKey: password
    - targetPath: postgresql.auth.secretKeys.adminPasswordKey
      kind: Secret
      name: backstage-database-superuser
      valuesKey: password
    - targetPath: postgresql.auth.secretKeys.replicationPasswordKey
      kind: Secret
      name: backstage-database-superuser
      valuesKey: password
    - targetPath: backstage.extraEnvVars["POSTGRES_USER"].value
      kind: Secret
      name: backstage-database-user
      valuesKey: username
    - targetPath: backstage.extraEnvVars["POSTGRES_PASSWORD"].value
      kind: Secret
      name: backstage-database-user
      valuesKey: password

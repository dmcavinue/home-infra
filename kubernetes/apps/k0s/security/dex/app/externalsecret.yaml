---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: dex-secret
  namespace: security
spec:
  refreshInterval: "30m"
  secretStoreRef:
    name: vault-kv-backend
    kind: SecretStore
  target:
    name: dex-secret
    template:
      type: Opaque
      engineVersion: v2
      data:
        values.yaml: |
          config:
            connectors:
            - type: ldap
              id: ldap
              name: LDAP
              config:
                host: "lldap"
                port: 636
                insecureNoSSL: false
                insecureSkipVerify: false
                bindDN: "uid={{.LLDAP_USER_DN}},ou=people,{{.LLDAP_LDAP_BASE_DN}}"
                bindPW: "{{.LLDAP_LDAP_USER_PASS}}"
                userSearch:
                  baseDN: "ou=people,{{.LLDAP_LDAP_BASE_DN}}"
                  username: uid
                  idAttr: uid
                  emailAttr: mail
                  nameAttr: displayName
                  preferredUsernameAttr: uid
                groupSearch:
                  baseDN: "ou=groups,{{.LLDAP_LDAP_BASE_DN}}"
                  filter: "(objectClass=groupOfUniqueNames)"
                  userMatchers:
                    - userAttr: DN
                      groupAttr: member
                  nameAttr: cn
            staticClients:
              - id: immich
                name: immich
                secret: "{{.IMMICH_CLIENT_SECRET}}"
                redirectURIs:
                  - "https://immich.nucstack.com/oauth2/callback"
                  - "https://immich.nucstack.com/auth/login"
              - id: oauth2-proxy
                name: oauth2-proxy
                secret: "{{.OAUTH2_CLIENT_SECRET}}"
                redirectURIs:
                  - "https://alertmanager.${DOMAIN}/oauth2/callback"
                  - "https://esphome.${DOMAIN}/oauth2/callback"
                  - "https://hubble.${DOMAIN}/oauth2/callback"
                  - "https://hass-code.${DOMAIN}/oauth2/callback"
                  - "https://loki.${DOMAIN}/oauth2/callback"
                  - "https://prometheus.${DOMAIN}/oauth2/callback"
                  - "https://thanos.${DOMAIN}/oauth2/callback"
                  - "https://zwavejs.${DOMAIN}/oauth2/callback"
                  - "https://cctv.${DOMAIN}/oauth2/callback"
  dataFrom:
    - extract:
        key: /security/lldap
    - extract:
        key: /security/oauth2-proxy
    - extract:
        key: /security/dex

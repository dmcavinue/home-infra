---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: minio
  namespace: storage
spec:
  interval: 30m
  chart:
    spec:
      chart: minio
      version: 5.0.13
      sourceRef:
        kind: HelmRepository
        name: minio
        namespace: flux-system
  maxHistory: 2
  install:
    createNamespace: false
    remediation:
      retries: 3
  values:
    mode: standalone
    existingSecret: "minio-secret"
    mountPath: "/export"
    replicas: 1
    environment:
      MINIO_STORAGE_CLASS_STANDARD: "EC:2"
      MINIO_BROWSER: "on"
    persistence:
      enabled: true
      storageClass: "local-path"
      volumeName: "minio"
      accessMode: ReadWriteOnce
      size: 20Gi
    ingress:
      enabled: true
      ingressClassName: nginx
      path: /
      hosts:
        - "minio.${DOMAIN}"
      tls:
        - secretName: "${DOMAIN/./-}-tls"
          hosts:
            - "minio.${DOMAIN}"
    consoleIngress:
      enabled: true
      ingressClassName: nginx
      path: /
      hosts:
        - "minio-console.${DOMAIN}"
      tls:
        - secretName: "${DOMAIN/./-}-tls"
          hosts:
            - "minio-console.${DOMAIN}"
    resources:
      requests:
        memory: 2Gi
    policies:
      - name: db-backup-rw
        statements:
          - effect: Allow
            resources:
              - 'arn:aws:s3:::db-backup/*'
            actions:
              - "s3:AbortMultipartUpload"
              - "s3:GetObject"
              - "s3:DeleteObject"
              - "s3:PutObject"
              - "s3:ListMultipartUploadParts"
    users:
      - accessKey: externalSecret
        existingSecret: db-backup-secret
        existingSecretKey: CONSOLE_ACCESS_KEY
        policy: db-backup-rw
    buckets:
      - name: db-backup
        policy: none
        purge: false
        versioning: false
        objectlocking: false
    extraSecret: minio-secret

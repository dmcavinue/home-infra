---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: unifi-downloader
  namespace: home-automation
spec:
  interval: 5m
  chart:
    spec:
      chart: k8s/charts/unifi-downloader/
      sourceRef:
        kind: GitRepository
        name: flux-system
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: "${SECRET_DOCKER_PRIVATE_REGISTRY}/unifi-downloader"
      tag: 0.1.2
    controller:
      replicas: 1
    nameOverride: unifi-downloader
    service:
      main:
        enabled: false
    podAnnotations:
      vault.hashicorp.com/agent-inject: 'true'
      vault.hashicorp.com/agent-init-first: 'true'
      vault.hashicorp.com/agent-inject-secret-config: kv/data/home-automation/unifi-downloader
      vault.hashicorp.com/agent-inject-template-config: |
        {{`{{- with secret "kv/data/home-automation/unifi-downloader" -}}
        export UNIFI_HOST="{{.Data.data.UNIFI_DOWNLOADER_HOST}}"
        export UNIFI_USER="{{.Data.data.UNIFI_DOWNLOADER_USERNAME}}"
        export UNIFI_PWD="{{.Data.data.UNIFI_DOWNLOADER_PASSWORD}}"
        export INTERVAL="60"
        {{- end }}`}}
      vault.hashicorp.com/role: home-automation-unifi-downloader
    command:
      - 'sh'
      - '-c'
    args:
      - '. /vault/secrets/config && /docker-entrypoint.sh'
    serviceAccount:
      create: true
      name: unifi-downloader
    resources:
      requests:
        memory: "64Mi"
        cpu: "250m"
      limits:
        memory: "128Mi"
    securityContext:
      allowPrivilegeEscalation: false
      runAsUser: 10000
      runAsGroup: 10000
      fsGroup: 10000
    persistence:
      download-path:
        enabled: true
        type: custom
        volumeSpec:
          hostPath:
            type: Directory
            path: /mnt/data/cctv/unifi
        mountPath: /download
      backup-path:
        enabled: true
        type: custom
        volumeSpec:
          nfs:
            path: "${SECRET_NFS_CCTV_PATH}"
            server: "${SECRET_NFS_HOST}"
        mountPath: /backup
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: kubernetes.io/hostname
                  operator: In
                  values:
                    - "nucstack-2-9"
                    - "nucstack-2-10"

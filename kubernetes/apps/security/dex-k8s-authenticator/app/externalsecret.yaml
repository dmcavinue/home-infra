---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: dex-k8s-authenticator-secret
  namespace: security
spec:
  refreshInterval: "30m"
  secretStoreRef:
    name: vault-kv-backend
    kind: SecretStore
  target:
    name: dex-k8s-authenticator-secret
    template:
      type: Opaque
      engineVersion: v2
      data:
        values.yaml: |
          global:
            deployEnv: "${ENVIRONMENT}"
          dexK8sAuthenticator:
            clusters:
            - name: k8s
              short_description: "k8s ${ENVIRONMENT} cluster"
              description: "k8s ${ENVIRONMENT} cluster"
              client_secret: {{.DEX_K8S_AUTHENTICATOR_CLIENT_SECRET}}
              issuer: "https://dex.${DOMAIN}"
              k8s_master_uri: "https://k8s.${DOMAIN}"
              client_id: dex-k8s-authenticator
              redirect_uri: "https://login.${DOMAIN}/callback/"
              k8s_ca_pem: |
                -----BEGIN CERTIFICATE-----
                MIIBdjCCAR2gAwIBAgIBADAKBggqhkjOPQQDAjAjMSEwHwYDVQQDDBhrM3Mtc2Vy
                dmVyLWNhQDE2ODI2MzY3NDMwHhcNMjMwNDI3MjMwNTQzWhcNMzMwNDI0MjMwNTQz
                WjAjMSEwHwYDVQQDDBhrM3Mtc2VydmVyLWNhQDE2ODI2MzY3NDMwWTATBgcqhkjO
                PQIBBggqhkjOPQMBBwNCAARIQTE+vgqeezoeSvGWebE9ccT39q+O2Xfoeb9V+a0f
                GjGH829gngN8kOMAEGnVYGKDPfIL7n2xhhA5DD/POWz7o0IwQDAOBgNVHQ8BAf8E
                BAMCAqQwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQU9q5zukp6vZS9hH/qXF5m
                k2eVIBEwCgYIKoZIzj0EAwIDRwAwRAIgNO3DHnKjJBuMbc66lMlPpEOiBtpaUZgf
                Edj9u7z+fxQCIHPkDkAHOTkMwD9X/oIORQg1AWzv54oVUQpPb6X3ceGK
                -----END CERTIFICATE-----
  data:
  - secretKey: DEX_K8S_AUTHENTICATOR_CLIENT_SECRET
    remoteRef:
      key: /security/dex
      property: DEX_K8S_AUTHENTICATOR_CLIENT_SECRET

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: dex-secret
  namespace: security
spec:
  refreshInterval: "30m"
  secretStoreRef:
    name: vault-kv-backend
    kind: SecretStore
  target:
    name: dex-secret
    template:
      type: Opaque
      engineVersion: v2
      data:
        values.yaml: |
          config:
            connectors:
              - type: ldap
                id: ldap
                name: LDAP
                config:
                  host: "lldap:389"
                  bindDN: "uid={{.DEX_LLDAP_USER}},cn=users,{{.LLDAP_LDAP_BASE_DN}}"
                  bindPW: "{{.DEX_LLDAP_PASSWORD}}"
                  userSearch:
                    baseDN: "cn=users,{{.LLDAP_LDAP_BASE_DN}}"
                    filter: "(objectClass=person)"
                    username: uid
                    idAttr: uid
                    emailAttr: mail
                    nameAttr: uid
                  groupSearch:
                    baseDN: "cn=groups,{{.LLDAP_LDAP_BASE_DN}}"
                    filter: "(objectClass=posixGroup)"
                    userAttr: uid
                    groupAttr: memberUid
                    nameAttr: cn
            staticClients:
              - id: oauth2-proxy
                name: oauth2-proxy
                secret: "{{.DEX_OAUTH2_CLIENT_SECRET}}"
                redirectURIs:
                  - "https://alertmanager.${DOMAIN}/oauth2/callback"
                  - "https://esphome.${DOMAIN}/oauth2/callback"
                  - "https://hubble.${DOMAIN}/oauth2/callback"
                  - "https://hass-code.${DOMAIN}/oauth2/callback"
                  - "https://thanos.${DOMAIN}/oauth2/callback"
                  - "https://zwavejs.${DOMAIN}/oauth2/callback"
                  - "https://cctv.${DOMAIN}/oauth2/callback"
                  - "https://oauth.${DOMAIN}/oauth2/callback"
  dataFrom:
    - extract:
        key: /security/lldap
    - extract:
        key: /security/dex
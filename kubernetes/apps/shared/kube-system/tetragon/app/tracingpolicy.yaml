---
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "tcp-connect"
spec:
  kprobes:
    - call: "tcp_connect"
      syscall: false
      args:
        - index: 0
          type: "sock"
    - call: "tcp_close"
      syscall: false
      args:
        - index: 0
          type: "sock"
    - call: "tcp_sendmsg"
      syscall: false
      args:
        - index: 0
          type: "sock"
        - index: 2
          type: int
---
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "sys-read-follow-prefix"
spec:
  kprobes:
    - call: "fd_install"
      syscall: false
      return: false
      args:
        - index: 0
          type: int
        - index: 1
          type: "file"
      selectors:
        - matchPIDs:
            - operator: NotIn
              followForks: true
              isNamespacePID: true
              values:
                - 1
          matchArgs:
            - index: 1
              operator: "Prefix"
              values:
                - "/etc/"
          matchActions:
            - action: FollowFD
              argFd: 0
              argName: 1
    - call: "sys_close"
      syscall: true
      args:
        - index: 0
          type: "int"
      selectors:
        - matchActions:
            - action: UnfollowFD
              argFd: 0
              argName: 0
    - call: "sys_read"
      syscall: true
      args:
        - index: 0
          type: "fd"
        - index: 1
          type: "char_buf"
          returnCopy: true
        - index: 2
          type: "size_t"
    - call: "sys_write"
      syscall: true
      args:
        - index: 0
          type: "fd"
        - index: 1
          type: "char_buf"
          sizeArgIndex: 3
        - index: 2
          type: "size_t"
---
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "sys-write"
spec:
  kprobes:
    - call: "sys_write"
      syscall: true
      args:
        - index: 0
          type: "int"
        - index: 1
          type: "char_buf"
          sizeArgIndex: 3
        - index: 2
          type: "size_t"
      # follow any non-init pids stdout e.g. exec into container
      selectors:
        - matchPIDs:
            - operator: NotIn
              followForks: true
              isNamespacePID: true
              values:
                - 1
              matchArgs:
                - index: 0
                  operator: "Equal"
                  values:
                    - "1"
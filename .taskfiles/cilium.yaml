---
version: "3"

tasks:
  
  status:
    cmds:
      - cilium clustermesh status --context k0s
      - cilium clustermesh status --context k8s
  connect-mesh:
    cmds:
      - cilium clustermesh connect --context k0s --destination-context k8s
  tetragon-policy-builder:
    cmds:
      - docker run -p 5000:5000 -e KUBECONFIG=/tmp/kubeconfig -v ./.kubeconfigs/{{.ENVIRONMENT}}.kubeconfig:/tmp/kubeconfig ghcr.io/camptocamp/tetragon-policy-builder:master
  tetragon-events:
    cmds:
      - kubectl --context {{.ENVIRONMENT}} logs --max-log-requests=6 -n kube-system -l app.kubernetes.io/name=tetragon -c export-stdout -f | tetra getevents -o compact --namespaces {{.namespace}}
    vars:
      namespace: '{{ or .namespace (fail "namespace `namespace` is required") }}'

---
version: '3'

tasks:
  bootstrap:
    desc: bootstrap auth/roles
    cmds:
      - task vault:disable-k8s-auth
      - task vault:enable-k8s-auth
      - task vault:add-roles
      - task vault:add-roles
      - task vault:add-kv-secrets
  status:
    desc: vault status
    cmds:
      - vault status
  unseal:
    desc: vault unseal
    cmds:
      - vault operator unseal {{.VAULT_UNSEAL_KEY_1}}
      - vault operator unseal {{.VAULT_UNSEAL_KEY_2}}
      - vault operator unseal {{.VAULT_UNSEAL_KEY_3}}
  # ldap
  enable-ldap:
    desc: configure vault ldap auth
    cmds:
      - vault auth disable ldap
      - vault auth enable ldap
      - vault write auth/ldap/config
          url="ldaps://{{.LDAP_SERVER}}"
          userattr=uid
          userdn="cn=users,{{.LDAP_ROOT}}"
          discoverdn=true
          groupdn="cn=groups,{{.LDAP_ROOT}}"
          groupfilter='(&(objectClass=posixGroup)(memberUid={{printf "{{.Username}}"}}))'
          groupattr="uid"
          binddn="uid={{.LDAP_ADMIN_USERNAME}},cn=users,{{.LDAP_ROOT}}"
          bindpass="{{.LDAP_ADMIN_PASSWORD}}"
          insecure_tls=false
          starttls=true
      - vault write auth/ldap/groups/vault-admin policies=admin
      - vault policy write admin {{.ROOT_DIR}}/tmpl/vault-admin.hcl
  # k8s auth
  enable-k8s-auth:
    desc: configure vault k8s auth for cluster
    cmds:
      - vault auth enable -path=kubernetes/{{.ENVIRONMENT}} kubernetes
      - kubectl -n kube-system apply -f {{.ROOT_DIR}}/kubernetes/templates/vault-auth.yaml
      - kubectl -n kube-system get secret vault-auth-token -o jsonpath="{.data['ca\.crt']}" | base64 -d > ca.crt
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/config
          token_reviewer_jwt="$(kubectl -n kube-system get secret vault-auth-token -o jsonpath=\"{.data.token}\" | base64 -d; echo)"
          kubernetes_host="https://{{.VIP_IP}}"
          kubernetes_ca_cert=@ca.crt
          disable_iss_validation=true
      - rm ca.crt
  disable-k8s-auth:
    desc: disable k8s auth
    cmds:
      - vault auth disable kubernetes/{{.ENVIRONMENT}}
  add-roles:
    desc: add k8s roles/policies
    cmds:
      - echo "path \"secret/{{.ENVIRONMENT}}/data/cluster\" { capabilities = [\"read\", \"list\"] }" | vault policy write cluster-secrets -
      - echo "path \"secret/{{.ENVIRONMENT}}/data/flux-system/*\" { capabilities = [\"read\", \"list\"] }" | vault policy write flux-system -
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/flux-system
          bound_service_account_names=vault-auth
          bound_service_account_namespaces=flux-system
          policies=cluster-secrets,flux-system,default
          ttl=1440h
      - echo "path \"secret/{{.ENVIRONMENT}}/data/database/*\" { capabilities = [\"read\", \"list\"] } " | vault policy write database -
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/database
          bound_service_account_names=vault-auth
          bound_service_account_namespaces=database
          policies=database,media,home-automation,default
          ttl=1440h
      - echo "path \"secret/{{.ENVIRONMENT}}/data/home-automation/*\" { capabilities = [\"read\", \"list\"] }" | vault policy write home-automation -
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/home-automation
          bound_service_account_names=vault-auth
          bound_service_account_namespaces=home-automation
          policies=volsync,database,home-automation,default
          ttl=1440h
      - echo "path \"secret/{{.ENVIRONMENT}}/data/media/*\" { capabilities = [\"read\", \"list\"] }" | vault policy write media -
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/media
          bound_service_account_names=vault-auth
          bound_service_account_namespaces=media
          policies=media,default
          ttl=1440h
      - echo "path \"secret/{{.ENVIRONMENT}}/data/monitoring/*\" { capabilities = [\"read\", \"list\"] }" | vault policy write monitoring -
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/monitoring
          bound_service_account_names=vault-auth
          bound_service_account_namespaces=monitoring
          policies=monitoring,default
          ttl=1440h
      - echo "path \"secret/{{.ENVIRONMENT}}/data/cert-manager/*\" { capabilities = [\"read\", \"list\"] }" | vault policy write cert-manager -
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/cert-manager
          bound_service_account_names=vault-auth
          bound_service_account_namespaces=cert-manager
          policies=cert-manager,default
          ttl=1440h
      - echo "path \"secret/{{.ENVIRONMENT}}/data/kube-system/*\" { capabilities = [\"read\", \"list\"] }" | vault policy write kube-system -
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/kube-system
          bound_service_account_names=vault-auth
          bound_service_account_namespaces=kube-system
          policies=kube-system,default
          ttl=1440h
      - echo "path \"secret/{{.ENVIRONMENT}}/data/ingress/*\" { capabilities = [\"read\", \"list\"] }" | vault policy write ingress -
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/ingress
          bound_service_account_names=vault-auth
          bound_service_account_namespaces=ingress
          policies=ingress,default
          ttl=1440h
      - echo "path \"secret/{{.ENVIRONMENT}}/data/volsync/*\" { capabilities = [\"read\", \"list\"] }" | vault policy write volsync -
      - echo "path \"secret/{{.ENVIRONMENT}}/data/volsync/frigate\" { capabilities = [\"read\", \"list\"] }" | vault policy write volsync-frigate -
      - echo "path \"secret/{{.ENVIRONMENT}}/data/volsync/home-assistant\" { capabilities = [\"read\", \"list\"] }" | vault policy write volsync-home-assistant -
      - echo "path \"secret/{{.ENVIRONMENT}}/data/volsync/zwavejs\" { capabilities = [\"read\", \"list\"] }" | vault policy write volsync-zwavejs -
      - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/volsync
          bound_service_account_names=vault-auth
          bound_service_account_namespaces=volsync
          policies=volsync,default
          ttl=1440h
  # database
#   disable-database-engine:
#     desc: disable vault database engine
#     cmds:
#       - vault secrets disable databases/{{.ENVIRONMENT}}
#   enable-database-engine:
#     desc: enable vault database engine
#     cmds:
#       - vault secrets enable -path=databases/{{.ENVIRONMENT}} database
#   add-database-connections:
#     desc: add vault database connections
#     cmds:
#       # postgresql/home_assistant
#       - vault write databases/{{.ENVIRONMENT}}/config/home_assistant
#           plugin_name="postgresql-database-plugin"
#           allowed_roles="home-assistant"
#           connection_url="postgresql://{{`{{username}}`}}:{{`{{password}}`}}@{{.POSTGRES_LB_IP}}:5432/home_assistant"
#           username="postgres"
#           password="{{.POSTGRES_PASSWORD}}"
#           username_template="{{`{{.RoleName}}`}}-{{`{{random 8}}`}}"
#       - vault write databases/{{.ENVIRONMENT}}/roles/home-assistant
#           db_name="home_assistant"
#           creation_statements="CREATE ROLE \"{{`{{name}}`}}\" WITH LOGIN PASSWORD '{{`{{password}}`}}' VALID UNTIL '{{`{{expiration}}`}}'; GRANT role_home_assistant TO \"{{`{{name}}`}}\"; SET ROLE role_home_assistant;"
#           revocation_statements="REVOKE role_home_assistant FROM \"{{`{{name}}`}}\"; DROP ROLE \"{{`{{name}}`}}\";"
#           default_ttl="1h"
#           max_ttl="1h"
#       # postgresql/immich
#       - vault write databases/{{.ENVIRONMENT}}/config/immich
#           plugin_name="postgresql-database-plugin"
#           allowed_roles="immich"
#           connection_url="postgresql://{{`{{username}}`}}:{{`{{password}}`}}@{{.POSTGRES_LB_IP}}:5432/immich"
#           username="postgres"
#           password="{{.POSTGRES_PASSWORD}}"
#           username_template="{{`{{.RoleName}}`}}-{{`{{random 8}}`}}"
#       - vault write databases/{{.ENVIRONMENT}}/roles/immich
#           db_name="immich"
#           creation_statements="CREATE ROLE \"{{`{{name}}`}}\" WITH LOGIN PASSWORD '{{`{{password}}`}}' VALID UNTIL '{{`{{expiration}}`}}';, GRANT role_immich TO \"{{`{{name}}`}}\"; SET ROLE role_immich;"
#           revocation_statements="REVOKE role_immich FROM \"{{`{{name}}`}}\"; DROP ROLE \"{{`{{name}}`}}\";"
#           default_ttl="1h"
#           max_ttl="1h"
#       # postgresql/windmill
#       - vault write databases/{{.ENVIRONMENT}}/config/windmill
#           plugin_name="postgresql-database-plugin"
#           allowed_roles="windmill"
#           connection_url="postgresql://{{`{{username}}`}}:{{`{{password}}`}}@{{.POSTGRES_LB_IP}}:5432/windmill"
#           username="postgres"
#           password="{{.POSTGRES_PASSWORD}}"
#           username_template="{{`{{.RoleName}}`}}-{{`{{random 8}}`}}"
#       - vault write databases/{{.ENVIRONMENT}}/roles/windmill
#           db_name="windmill"
#           creation_statements="CREATE ROLE \"{{`{{name}}`}}\" WITH LOGIN PASSWORD '{{`{{password}}`}}' VALID UNTIL '{{`{{expiration}}`}}'; GRANT role_windmill TO \"{{`{{name}}`}}\"; SET ROLE role_windmill;"
#           revocation_statements="REVOKE role_windmill FROM \"{{`{{name}}`}}\"; DROP ROLE \"{{`{{name}}`}}\";"
#           default_ttl="1h"
#           max_ttl="1h"
  # kv
  disable-kv:
    desc: disable kv secrets engine
    cmds:
      - vault secrets disable secret/{{.ENVIRONMENT}}
  enable-kv:
    desc: enable kv secrets engine
    cmds:
      - vault secrets enable -path=secret/{{.ENVIRONMENT}} kv-v2
  add-kv-secrets:
    desc: add kv secrets
    cmds:
      # shared secrets
      - vault kv put -mount=secret/{{.ENVIRONMENT}} cluster
          CILIUM_LB_IP="{{.CILIUM_LB_IP}}"
          CLOUDFLARE_EMAIL="{{.CLOUDFLARE_EMAIL}}"
          DOMAIN="{{.DOMAIN}}"
          DOCKER_PRIVATE_REGISTRY="{{.DOCKER_PRIVATE_REGISTRY}}"
          ENVIRONMENT="{{.ENVIRONMENT}}"
          EMQX_LB_IP="{{.EMQX_LB_IP}}"
          LOCAL_DOMAIN="{{.LOCAL_DOMAIN}}"
          NFS_SERVER_IP="{{.NFS_SERVER_IP}}"
          SERVER_CIDR="{{.SERVER_CIDR}}"
          VIP_IP="{{.VIP_IP}}"
          VIP_PORT="{{.VIP_PORT}}"
      # cert-manager
      - vault kv put -mount=secret/{{.ENVIRONMENT}} cert-manager/cloudflare          
          CLOUDFLARE_TOKEN="{{.CLOUDFLARE_TOKEN}}"
      # flux-system
      - vault kv put -mount=secret/{{.ENVIRONMENT}} flux-system/notification
          FLUX_SLACK_WEBHOOK="{{.SLACK_WEBHOOK}}"
      # database/emqx
      - vault kv put -mount=secret/{{.ENVIRONMENT}} database/emqx
          admin_password="{{.EMQX_ADMIN_PASSWORD}}"
          user_1_username="{{.EMQX_USER1_NAME}}"
          user_1_password="{{.EMQX_USER1_PASSWORD}}"
      # media/immich
      - vault kv put -mount=secret/{{.ENVIRONMENT}} media/immich
          IMMICH_JWT_SECRET="{{.IMMICH_JWT_SECRET}}"
          IMMICH_TYPESENSE_API_KEY="{{.IMMICH_TYPESENSE_API_KEY}}"
          IMMICH_POSTGRES_SUPER_USER="{{.IMMICH_POSTGRES_SUPER_USER}}"
          IMMICH_POSTGRES_SUPER_PASSWORD="{{.IMMICH_POSTGRES_SUPER_PASSWORD}}"
          IMMICH_POSTGRES_USER="{{.IMMICH_POSTGRES_USER}}"
          IMMICH_POSTGRES_PASSWORD="{{.IMMICH_POSTGRES_PASSWORD}}"
      # home-automation/home-assistant
      - vault kv put -mount=secret/{{.ENVIRONMENT}} home-automation/home-assistant
          HASS_POSTGRES_SUPER_USER="{{.HASS_POSTGRES_SUPER_USER}}"
          HASS_POSTGRES_SUPER_PASSWORD="{{.HASS_POSTGRES_SUPER_PASSWORD}}"
          HASS_POSTGRES_USER="{{.HASS_POSTGRES_USER}}"
          HASS_POSTGRES_PASSWORD="{{.HASS_POSTGRES_PASSWORD}}"
          ALARM_CODE="{{.HASS_ALARM_CODE}}"
          GIT_REPO="{{.HASS_GIT_REPO}}"
          DEPLOY_KEY_B64="{{.HASS_DEPLOY_KEY_B64}}"
          HACS_TOKEN="{{.HASS_HACS_TOKEN}}"
          LDAP_ROOT="{{.LDAP_ROOT}}"
          LOCAL_DOMAIN="{{.LOCAL_DOMAIN}}"
          LOCATION_LAT="{{.HASS_LOCATION_LAT}}"
          LOCATION_LONG="{{.HASS_LOCATION_LONG}}"
      # home-automation/frigate
      - vault kv put -mount=secret/{{.ENVIRONMENT}} home-automation/frigate
          DVR_URL="{{.FRIGATE_DVR_URL}}"
          CAM1_NAME="{{.FRIGATE_CAM1_NAME}}"
          CAM1_ID="{{.FRIGATE_CAM1_ID}}"
          CAM2_NAME="{{.FRIGATE_CAM2_NAME}}"
          CAM2_ID="{{.FRIGATE_CAM2_ID}}"
          CAM3_NAME="{{.FRIGATE_CAM3_NAME}}"
          CAM3_ID="{{.FRIGATE_CAM3_ID}}"
          CAM4_NAME="{{.FRIGATE_CAM4_NAME}}"
          CAM4_ID="{{.FRIGATE_CAM4_ID}}"
          CAM5_NAME="{{.FRIGATE_CAM5_NAME}}"
          CAM5_ID="{{.FRIGATE_CAM5_ID}}"
          CAM6_NAME="{{.FRIGATE_CAM6_NAME}}"
          CAM6_ID="{{.FRIGATE_CAM6_ID}}"
          CAM7_NAME="{{.FRIGATE_CAM7_NAME}}"
          CAM7_ID="{{.FRIGATE_CAM7_ID}}"
          CAM8_NAME="{{.FRIGATE_CAM8_NAME}}"
          CAM8_ID="{{.FRIGATE_CAM8_ID}}"
          PLUS_API_KEY="{{.FRIGATE_PLUS_API_KEY}}"
      # monitoring/grafana
      - vault kv put -mount=secret/{{.ENVIRONMENT}} monitoring/grafana
          ADMIN_USER="{{.GRAFANA_ADMIN_USER}}"
          ADMIN_PASSWORD="{{.GRAFANA_ADMIN_PASSWORD}}"
          LDAP_SERVER="{{.GRAFANA_LDAP_SERVER}}"
          LDAP_USERNAME="{{.GRAFANA_LDAP_USERNAME}}"
          LDAP_PASSWORD="{{.GRAFANA_LDAP_PASSWORD}}"
          LDAP_ROOT="{{.GRAFANA_LDAP_ROOT}}"
      # volsync
      - vault kv put -mount=secret/{{.ENVIRONMENT}} volsync/volsync
          RESTIC_URL="{{.RESTIC_URL}}"
      - vault kv put -mount=secret/{{.ENVIRONMENT}} volsync/frigate
          RESTIC_FRIGATE_PASSWORD="{{.RESTIC_FRIGATE_PASSWORD}}"
      - vault kv put -mount=secret/{{.ENVIRONMENT}} volsync/home-assistant
          RESTIC_HASS_PASSWORD="{{.RESTIC_HASS_PASSWORD}}"
      - vault kv put -mount=secret/{{.ENVIRONMENT}} volsync/zwavejs
          RESTIC_ZWAVEJS_PASSWORD="{{.RESTIC_ZWAVEJS_PASSWORD}}"

    #   # home-automation/rtlamr-collect
    #   - vault kv put -mount=secret/{{.ENVIRONMENT}} home-automation/rtlamr-collect
    #       RTLAMR_METERS="{{.RTLAMR_METERS}}"
    #       RTLAMR_MSGTYPE="{{.RTLAMR_MSGTYPE}}"
    #       INFLUXDB_USER="{{.INFLUXDB_USER}}"
    #       INFLUXDB_PASSWORD="{{.INFLUXDB_PASSWORD}}"
    #   - echo "path \"secret/data/home-automation/rtlamr-collect\" { capabilities = [\"read\", \"list\"] }" | vault policy write home-automation-rtlamr-collect -
    #   - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/home-automation-rtlamr-collect
    #       bound_service_account_names=rtlamr-collect
    #       bound_service_account_namespaces=home-automation
    #       policies=home-automation-rtlamr-collect,default
    #       ttl=1440h
    #   # home-automation/tidbyt-proxy
    #   - vault kv put -mount=secret/ home-automation/tidbyt-proxy
    #       TIDBYT_API_KEY="{{.TIDBYT_API_KEY}}"
    #       TIDBYT_DEVICE_ID="{{.TIDBYT_DEVICE_ID}}"
    #   - echo "path \"secret/data/home-automation/tidbyt-proxy\" { capabilities = [\"read\", \"list\"] }" | vault policy write home-automation-tidbyt-proxy -
    #   - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/home-automation-tidbyt-proxy
    #       bound_service_account_names=tidbyt-proxy
    #       bound_service_account_namespaces=home-automation
    #       policies=home-automation-tidbyt-proxy,default
    #       ttl=1440h
    #   # home-automation/unifi-downloader
    #   - vault kv put -mount=secret/ home-automation/unifi-downloader
    #       UNIFI_DOWNLOADER_HOST="{{.UNIFI_DOWNLOADER_HOST}}"
    #       UNIFI_DOWNLOADER_USERNAME="{{.UNIFI_DOWNLOADER_USERNAME}}"
    #       UNIFI_DOWNLOADER_PASSWORD="{{.UNIFI_DOWNLOADER_PASSWORD}}"
    #   - echo "path \"secret/data/home-automation/unifi-downloader\" { capabilities = [\"read\", \"list\"] }" | vault policy write home-automation-unifi-downloader -
    #   - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/home-automation-unifi-downloader
    #       bound_service_account_names=unifi-downloader
    #       bound_service_account_namespaces=home-automation
    #       policies=home-automation-unifi-downloader,default
    #       ttl=1440h
    #   # observability/influxdb
    #   - vault kv put -mount=secret/ observability/influxdb
    #       INFLUXDB_USER="{{.INFLUXDB_USER}}"
    #       INFLUXDB_PASSWORD="{{.INFLUXDB_PASSWORD}}"
    #   - echo "path \"secret/data/observability/influxdb\" { capabilities = [\"read\", \"list\"] }" | vault policy write observability-influxdb -
    #   - vault write auth/kubernetes/{{.ENVIRONMENT}}/role/observability-influxdb
    #       bound_service_account_names=influxdb
    #       bound_service_account_namespaces=observability
    #       policies=observability-influxdb,default
    #       ttl=1440h
